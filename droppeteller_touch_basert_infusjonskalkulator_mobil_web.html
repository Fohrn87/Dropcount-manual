<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Touch-droppeteller & infusjonskalkulator</title>
  <style>
    :root { --bg:#0b0d12; --card:#111520; --muted:#8892a6; --accent:#6ee7b7; --warn:#f6c453; --border:#1f2533; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e7eef9;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:900px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
    h1{font-size:18px;margin:6px 0}
    h2{font-size:16px;margin:6px 0;color:#d5def0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:#cfd8ea}
    input,select,button{background:#0f1422;color:#e7eef9;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:15px}
    button{cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
    .metric{background:#0e1420;border:1px solid var(--border);border-radius:14px;padding:10px;text-align:center}
    .metric .v{font-weight:700;font-size:24px}
    .metric .k{font-size:12px;color:var(--muted)}
    .tap{display:grid;place-items:center;border:2px dashed #2b3244;border-radius:18px;height:180px;user-select:none;-webkit-user-select:none}
    .tap button{width:100%;height:100%;border-radius:14px;border:2px solid #2b3244;background:#141a2a;font-size:20px}
    .tap button:active{background:#192136}
    .muted{color:var(--muted);font-size:12px}
    .ok{color:var(--accent)}
    .warn{color:var(--warn)}
    .cols{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width:760px){.cols{grid-template-columns:1fr}}
    .hr{height:1px;background:var(--border);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Touch-droppeteller & infusjonskalkulator</h1>
    <div class="muted">Beta – ikke medisinsk utstyr. Verifiser alltid mot kliniske metoder.</div>

    <div class="card">
      <h2>1) Tapping av dråper</h2>
      <div class="row">
        <label>Dråpefaktor (gtt/mL)
          <input id="dropFactor" type="number" value="20" min="5" max="120" step="1" style="width:90px" />
        </label>
        <label>Anti-dobbelttelling (ms)
          <input id="minInterval" type="number" value="200" min="100" max="1000" step="10" style="width:110px" />
        </label>
        <button id="btnReset">Nullstill</button>
      </div>

      <div class="tap" style="margin-top:8px">
        <button id="btnTap">TAPP HER HVER GANG EN DRÅPE FALLER</button>
      </div>

      <div class="grid" style="margin-top:8px">
        <div class="metric"><div class="v" id="mTaps">0</div><div class="k">Tapp (dråper)</div></div>
        <div class="metric"><div class="v" id="mDpm">0.0</div><div class="k">DPM (dråper/min)</div></div>
        <div class="metric"><div class="v" id="mMlh">0.0</div><div class="k">mL/h (beregnet)</div></div>
      </div>
      <div class="muted" id="status">Tapp i jevn rytme. Systemet bruker glidende snitt.</div>
    </div>

    <div class="card">
      <h2>2) Legemiddelkonsentrasjon</h2>
      <div class="cols">
        <div>
          <label>Mengde virkestoff
            <div class="row">
              <input id="doseAmt" type="number" value="5" step="0.1" style="width:120px">
              <select id="doseAmtUnit">
                <option value="mg" selected>mg</option>
                <option value="mcg">µg</option>
              </select>
            </div>
          </label>
          <div style="height:6px"></div>
          <label>Totalt volum (mL)
            <input id="totalVol" type="number" value="50" step="1" style="width:120px">
          </label>
        </div>
        <div>
          <div class="metric">
            <div class="v" id="mConc">–</div>
            <div class="k">Konsentrasjon (µg/mL)</div>
          </div>
          <div class="muted">Angi mengde og totalvolum for å få konsentrasjon.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>3) Dose ↔️ Hastighet</h2>
      <div class="cols">
        <div>
          <h3 style="margin:4px 0">A) Beregn <u>gitt hastighet</u> (fra tapping)</h3>
          <div class="row">
            <label>Vekt (kg)
              <input id="weightA" type="number" value="70" step="0.1" style="width:110px">
            </label>
          </div>
          <div class="grid" style="margin-top:8px">
            <div class="metric"><div class="v" id="mDoseUgMin">0.0</div><div class="k">µg/min (leveres)</div></div>
            <div class="metric"><div class="v" id="mDoseUgKgMin">0.000</div><div class="k">µg/kg/min (leveres)</div></div>
            <div class="metric"><div class="v" id="mDoseMgHr">0.000</div><div class="k">mg/h (leveres)</div></div>
          </div>
        </div>
        <div>
          <h3 style="margin:4px 0">B) Beregn <u>påkrevd hastighet</u> (mål-dose)</h3>
          <div class="row">
            <label>Mål-dose
              <input id="targetDose" type="number" value="0.05" step="0.005" style="width:120px">
            </label>
            <select id="targetUnit">
              <option value="ugkgmin" selected>µg/kg/min</option>
              <option value="ugmin">µg/min</option>
              <option value="mghr">mg/h</option>
            </select>
            <label>Vekt (kg)
              <input id="weightB" type="number" value="70" step="0.1" style="width:110px">
            </label>
          </div>
          <div class="grid" style="margin-top:8px">
            <div class="metric"><div class="v" id="mReqMlMin">0.00</div><div class="k">mL/min kreves</div></div>
            <div class="metric"><div class="v" id="mReqMlHr">0.0</div><div class="k">mL/h kreves</div></div>
            <div class="metric"><div class="v" id="mReqDpm">0</div><div class="k">DPM (ved valgt gtt/mL)</div></div>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top:6px">Bruk del A når du måler faktisk hastighet med tapping. Bruk del B for å finne hvilken hastighet du skal stille inn for ønsket dose.</div>
    </div>

    <div class="muted">Ansvarsfraskrivelse: Denne kalkulatoren er kun for støtte og må ikke brukes alene som beslutningsgrunnlag i pasientbehandling. Dobbeltsjekk alltid tall mot lokale retningslinjer/utstyr.</div>
  </div>

  <script>
    // ----- State -----
    let taps = 0; let lastTap = 0; let minInterval = 200; // ms
    let emaDpm = null; const EMA_A = 0.25; // litt raskere respons ved manuell tapping

    function $(id){ return document.getElementById(id); }

    function toNumber(id){ const v = parseFloat($(id).value); return isFinite(v)?v:0; }

    function updateFromTaps(){
      const df = toNumber('dropFactor');
      const dpm = emaDpm || 0;
      const mlh = df>0 ? (dpm/df)*60.0 : 0;
      $('mTaps').textContent = taps;
      $('mDpm').textContent = dpm.toFixed(1);
      $('mMlh').textContent = mlh.toFixed(1);
      updateDeliveredDose(mlh);
      updateRequiredFromTarget();
    }

    function tap(){
      const now = performance.now();
      const block = toNumber('minInterval');
      if (now - lastTap < block) { $('status').textContent = 'Ignorerte for rask dobbel-tap (anti-dobbelttelling).'; return; }
      // beregn DPM fra intervall
      if (lastTap>0){
        const dt = now - lastTap; // ms
        if (dt>=200 && dt<=10000){
          const instDpm = 60000.0/dt;
          emaDpm = (emaDpm==null)?instDpm:(EMA_A*instDpm + (1-EMA_A)*emaDpm);
        }
      }
      lastTap = now; taps += 1; $('status').textContent = 'Registrert dråpe.'; updateFromTaps();
    }

    function resetAll(){ taps=0; lastTap=0; emaDpm=null; $('status').textContent='Nullstilt.'; updateFromTaps(); }

    // ----- Concentration helpers -----
    function getConcUgPerMl(){
      const amt = toNumber('doseAmt');
      const unit = $('doseAmtUnit').value; // mg | mcg
      const vol = toNumber('totalVol');
      if (vol<=0 || amt<=0) return 0;
      const ug = unit==='mg' ? amt*1000.0 : amt; // mg→µg
      return ug/vol; // µg/mL
    }

    function updateConcBox(){
      const c = getConcUgPerMl();
      $('mConc').textContent = c>0? c.toFixed(1): '–';
    }

    // ----- A) Delivered dose from measured rate -----
    function updateDeliveredDose(mlh){
      const conc = getConcUgPerMl(); // µg/mL
      const kg = toNumber('weightA');
      const mlmin = mlh/60.0;
      const ugmin = mlmin*conc;
      const ugkgmin = kg>0 ? ugmin/kg : 0;
      const mghr = ugmin*60.0/1000.0; // µg/min → mg/h
      $('mDoseUgMin').textContent = ugmin.toFixed(1);
      $('mDoseUgKgMin').textContent = ugkgmin.toFixed(3);
      $('mDoseMgHr').textContent = mghr.toFixed(3);
    }

    // ----- B) Required rate for target dose -----
    function updateRequiredFromTarget(){
      const conc = getConcUgPerMl(); // µg/mL
      const unit = $('targetUnit').value;
      const df = toNumber('dropFactor');
      const kg = toNumber('weightB');
      const val = toNumber('targetDose');
      if (conc<=0 || val<=0){ $('mReqMlMin').textContent='0.00'; $('mReqMlHr').textContent='0.0'; $('mReqDpm').textContent='0'; return; }

      let ugPerMin;
      if (unit==='ugkgmin'){ ugPerMin = val * Math.max(kg,0); }
      else if (unit==='ugmin'){ ugPerMin = val; }
      else if (unit==='mghr'){ ugPerMin = (val*1000.0)/60.0; } // mg/h → µg/min
      else ugPerMin = 0;

      const mlPerMin = ugPerMin/conc; // (µg/min) / (µg/mL) = mL/min
      const mlPerHr = mlPerMin*60.0;
      const dpm = Math.round((mlPerHr/60.0) * df * 60.0); // (mL/h)/60 = mL/min; *df=gtt/min; *? Wait → simpler:
      const dpm2 = Math.round((mlPerHr * df) / 1.0); // since mL/h * (gtt/mL) / (h/min conversion)
      // Correct calculation: DPM = (mL/h * gtt/mL) / 60
      const dpmCorrect = Math.round((mlPerHr * df) / 60.0);

      $('mReqMlMin').textContent = mlPerMin.toFixed(2);
      $('mReqMlHr').textContent = mlPerHr.toFixed(1);
      $('mReqDpm').textContent = dpmCorrect.toString();
    }

    // ----- Events -----
    window.addEventListener('DOMContentLoaded', ()=>{
      $('btnTap').addEventListener('click', tap);
      $('btnTap').addEventListener('touchstart', (e)=>{ e.preventDefault(); tap(); }, {passive:false});
      $('btnReset').addEventListener('click', resetAll);
      ['dropFactor','minInterval','doseAmt','doseAmtUnit','totalVol','weightA','weightB','targetDose','targetUnit']
        .forEach(id=> $(id).addEventListener('input', ()=>{ updateConcBox(); updateFromTaps(); }));
      updateConcBox(); updateFromTaps();
    });
  </script>
</body>
</html>
